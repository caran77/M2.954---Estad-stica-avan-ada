---
title: "A2"
author: "Carlos A. García"
date: "March 30, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Càrrega del fitxer

##Carregueu l'arxiu de dades en R. Independentment del fitxer que vàreu obtenir en l'activitat 1, useu el fitxer "rawData_clean.csv". Un cop carregat el fitxer, valideu que els tipus de dades són els correctes. Si no és així, feu les conversions de tipus oportunes.

Primer establim el directori de feina
```{r directori de feina}
setwd("D:/Users/cagarcia/uoc/M2.954 - Estadística avançada/A2")
```

Llegim el fitxer proporcionat a la pràctica

```{r llegir el document}
satisfaccioLaboral <- read.csv2("rawData_clean.csv", header = TRUE, sep = ",", dec = ".")
attach(satisfaccioLaboral)

summary(satisfaccioLaboral)
```
Validem que els tipus de dades (classes) són correctes
```{r validem les classes}
sapply(satisfaccioLaboral, class)
```

##Gràfic de totes les variables:
```{r gràfic de les variables}
plot(city, main="Distribució de persones per ciutat", xlab="ciutat", 
     ylab="Número de persones", col="#ADD8E6", lwd = 2)

sexDesc <- factor(sex, levels=c("M","F"), labels=c("Home","Dona"))
plot(sexDesc, main="Distribució de persones per sexe", xlab="sexe", 
     ylab="número de persones", col="#ADD8E6", lwd = 2)

educDesc <- factor(educ_level, levels=c("N","P","S","U"), labels=c("Sense estudis","Primària", "Secundària", "Universitat"))
plot(educDesc, main="Distribució de persones per nivell d'educació", 
     xlab="Nivell educatiu", ylab="Número de persones", col="#ADD8E6", lwd = 2)

jobTypeDesc <- factor(job_type, levels=c("C","PC"), labels=c("Qualificat", "Poc qualificat"))
plot(jobTypeDesc, main="Distribució de persones per qualificació professional", 
     xlab="Qualificació professional", ylab="Número de persones", col="#ADD8E6", lwd = 2)

hist(happiness, breaks=c(0:10), main="Distribució de persones per nivell de felicitat", 
     xlab="Nivell de felicitat (0-10). En vermell els quantils", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(happiness), col="red", lwd=3)

den.happiness <- density(happiness)
plot(den.happiness, col="black", main="Densitat de persones per nivell de felicitat",
     xlab="Nivell de felicitat", ylab="Persones")

hist(age, breaks=c(min(age):max(age)), main="Distribució de persones per edat", 
     xlab="Edat de les persones de la mostra. En vermell els quantils", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(age), col="red", lwd=3)

hist(seniority, breaks=c(min(seniority):max(seniority)), main="Distribució de persones per anys d'experiència", 
     xlab="Experiència de les persones de la mostra. En vermell els quantils", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(seniority), col="red", lwd=3)

max_work_hours <- max(work_hours)+1
hist(work_hours, breaks=c(min(work_hours):max_work_hours), main="Distribució de persones per hores de feina setmanals", 
     xlab="Hores setmanals. En vermell els quantils", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(work_hours), col="red", lwd=3)

par(mfrow=c(1,2))
max_sick_leave <- max(sick_leave) + 5
hist(sick_leave[sick_leave>0], breaks=seq(from=0, to=max_sick_leave, by=5), main="Persones per dies d'absència", 
     xlab="Dies d'absència
     (al menys 1)", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(sick_leave[sick_leave>0]), col="red", lwd=3)
sick_leave_bDesc <- factor(sick_leave_b, levels=c("0","1"), labels=c("No baixes", "Baixes"))
plot(sick_leave_bDesc, main="", 
     xlab="Indicador de baixa", ylab="Número de persones", col="#ADD8E6", lwd = 2)


hist(Cho_initial, main="Nivell de colesterol inicial", 
     xlab="Nivell de colesterol
     (en vermell els quantils)", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(Cho_initial), col="red", lwd=3)
hist(Cho_final, main="Nivell de colesterol final", 
     xlab="Nivell de colesterol
     (en vermell els quantils)", ylab="Número de persones", col="#ADD8E6")
abline(v=quantile(Cho_final), col="red", lwd=3)
dev.off()

```
#Satisfacció en el treball en relació al sexe
##Boxplot
Càlcul de happiness en funció del sexe
Primer desglosem l'informació en funció del sexe
```{r dataframe depenent del sexe}
satisfaccioLaboral.dones <- satisfaccioLaboral[sex=="F",]
satisfaccioLaboral.homes <- satisfaccioLaboral[sex=="M",]
boxplot(satisfaccioLaboral.dones$happiness, main="Satisfacció laboral (dones)", 
   xlab="", ylab="Nivell de satisfacció", col="#ADD8E6")
boxplot.stats(satisfaccioLaboral.dones$happiness)$out
summary(satisfaccioLaboral.dones$happiness)
sd(satisfaccioLaboral.dones$happiness)
boxplot(satisfaccioLaboral.homes$happiness, main="Satisfacció laboral (homes)", 
   xlab="", ylab="Nivell de satisfacció", col="#ADD8E6")
boxplot.stats(satisfaccioLaboral.homes$happiness)$out
summary(satisfaccioLaboral.homes$happiness)
sd(satisfaccioLaboral.homes$happiness)
```
A nivell visual no hi ha una gran diferència per sexe. Els interquantils són pràcticament els mateixos. Sí que tenim més valors outliers per adalt en el cas d'homes (3 vs 1) i més per abaix en cas de dones (2 vs 1). 

Calculem els tres intervals (happiness de la mostra total, happiness de les dones i happiness dels homes):

```{r interval de confiança del 90}
margError <- qt(0.05, df=(nrow(satisfaccioLaboral)-1), 
                lower.tail=FALSE)*sd(happiness)/sqrt(nrow(satisfaccioLaboral)) 
intEsq <- mean(happiness)-margError
intDer <- mean(happiness)+margError
print(c(intEsq, intDer))

margError <- qt(0.05, df=(nrow(satisfaccioLaboral)-1), lower.tail=FALSE)*
                sd(satisfaccioLaboral.dones$happiness)/sqrt(nrow(satisfaccioLaboral)) 
intEsq <- mean(satisfaccioLaboral.dones$happiness)-margError
intDer <- mean(satisfaccioLaboral.dones$happiness)+margError
print(c(intEsq, intDer))

margError <- qt(0.05, df=(nrow(satisfaccioLaboral)-1), lower.tail=FALSE)*
                sd(satisfaccioLaboral.homes$happiness)/sqrt(nrow(satisfaccioLaboral)) 
intEsq <- mean(satisfaccioLaboral.homes$happiness)-margError
intDer <- mean(satisfaccioLaboral.homes$happiness)+margError
print(c(intEsq, intDer))
```
L'interval de confiança ens dóna un 90% de probabilitats de que la mitjana poblacional es trobi en el rang indicat.

##Escriure la hipòtesi nul·la i alternativa

Si mirem les dades anteriors, podem apreciar que els valors estadístics descriptius són molt similars: la mitja i la mediana són pràcticament idèntiques. La major diferència la trobem a la variança.

Analitzarem dues possibles hipòtesis nul·les (i en conseqüència dues alternatives) per intentar veure si el nivell de happiness és diferent en homes que en dones:

\begin{enumerate}
\item Hipòtesi nul·la: Les mitjanes són diferents. Alternativa: són iguals i, per tant, indistinguibles.
\item	Hipòtesi nul·la: Les variances són diferents. Alternativa: són iguals i, per tant, indistinguibles.
\end{enumerate}

##Mètode
En el nostre cas, no coneixem ni la mitjana ni la variança poblacional. Només coneixem la mitjana i la variança de la mostra.
El nostre objectiu és clar: intentar veure si el nivell de felicitat (happiness) depèn del sexe de la persona. Això ho podrem comprovar comparant les mitjanes i variances mostrals.
En aquest cas, per a contrastar les mitjanes, un mètode adequat és el t de Student. El mateix és aplicable al contrast de variances.

##Calcular l'estadístic de contrast, el valor crític i el valor p
Per lo que podem veure, hem de rebutjar ambdues hipòtesis nules. El rang de la mitjana inclou el valor 0 i el de la variança l'1. 
```{r Hipotesi nul·la vs alternativa de la mitjana}
var.test(happiness ~ sex, alternative='two.sided', conf.level=.95, var.equal=FALSE, 
  data=satisfaccioLaboral)
```
```{r Hipotesi nul·la vs alternativa de la variança}
t.test(happiness~sex, alternative='two.sided', conf.level=.95, var.equal=FALSE, 
       data=satisfaccioLaboral)
```
Com es pot veure adalt, els respectius valors de p són  p-value = 0.8536 i  p-value = 0.9851.

Si considerem ambdues distribucions per separat (dones i homes), podem calcular els valors crítics de la mitja amb la distribució Khi-quadrat i calcular l'interval de confiança:

```{r Khi qaudrat de les mitjes}
qchisq(c(0.975,0.025), df=nrow(satisfaccioLaboral), lower.tail=TRUE)
((nrow(satisfaccioLaboral) - 1)*mean(satisfaccioLaboral.dones$happiness)) /  
  qchisq(c(0.975,0.025), df=nrow(satisfaccioLaboral), lower.tail=TRUE)
((nrow(satisfaccioLaboral) - 1)*mean(satisfaccioLaboral.homes$happiness)) /  
  qchisq(c(0.975,0.025), df=nrow(satisfaccioLaboral), lower.tail=TRUE)

```

##Interpretar el resultat
Segons la mostra de dades, podem afirmar que no hi ha diferència de happiness depenen del sexe de la persona. Les mostres són molt similars i els indicadors no ens permeten afirmar que hi ha cap diferèncie entre ambdues mostres (dones i homes).

#Test no paramètric

##Hipòtesi nul·la i alternativa
Primer mirem si realment hi ha diferències entre els boxplot de les dues mostres (C i PC)

```{r Anàlisi seniority depenent de job_type}
satisfaccioLaboral.seniorityC <- satisfaccioLaboral[job_type=="C",]
satisfaccioLaboral.seniorityPC <- satisfaccioLaboral[job_type=="PC",]
boxplot(satisfaccioLaboral.seniorityC$seniority, main="Seniority (nivell C)", 
   xlab="", ylab="Seniority (anys)", col="#ADD8E6")
boxplot.stats(satisfaccioLaboral.seniorityC$seniority)$out
boxplot(satisfaccioLaboral.seniorityPC$seniority, main="Seniority (nivell PC)", 
   xlab="", ylab="Seniority (anys)", col="#ADD8E6")
boxplot.stats(satisfaccioLaboral.seniorityPC$seniority)$out
```
\begin{enumerate}
\item Hipòtesi nul·la: Les mitjanes són diferents. Alternativa: són iguals i, per tant, indistinguibles.
\end{enumerate}

##Assumpció de normalitat
Tests de normalitat de les variables numèriques
```{r qplot of numeric}
par(mfrow=c(2,2))
qqplot(seniority, rnorm(nrow(satisfaccioLaboral)), main="Seniority", ylab = NULL)
qqplot(age, rnorm(nrow(satisfaccioLaboral)), main="Age", ylab = NULL)
qqplot(sick_leave, rnorm(nrow(satisfaccioLaboral)), main="Sick leave", ylab = NULL)
qqplot(work_hours, rnorm(nrow(satisfaccioLaboral)), main="Work hours", ylab = NULL)
```

```{r qplot of numeric_cho}
par(mfrow=c(1,2))
qqplot(Cho_initial, rnorm(nrow(satisfaccioLaboral)), main="Cho initial", ylab = NULL)
qqplot(Cho_final, rnorm(nrow(satisfaccioLaboral)), main="Cho  final", ylab = NULL)
```

```{r qplot of happiness}
qqplot(happiness, rnorm(nrow(satisfaccioLaboral)), main="Happiness", ylab = NULL)
```
Com es pot veure visualment, la variable que més segueix la distribució normal és Happiness. Recordem que:
\begin{enumerate}
\item Si la línia és recta, llavors la variable segueix totalment la distribució normal
\item Si la línia fa curva, llavors les dades poden estar esbiaixades (podem veure, per exemple, una lleu corva a la variable seniority)
\item  Si hi ha valors que no segueixen la línia, llavors aquests no segueixen la distribució normal. És el cas de seniority, age, sick leave, inici i final de happiness, ...
\end{enumerate}
Ho podem validar executant el test de Shapiro-Wilk per a totes les variables. Si el valor és proper a 1, llavors s'accepta l'hipòtesi de que la variable segueix una distribució normal. Com es pot veure a continuació, happiness o age segueixen molt fortament la distribució normal.
```{r tests de Shapiro-Wilk}
shapiro.test(seniority)
shapiro.test(age)
shapiro.test(sick_leave)
shapiro.test(work_hours)
shapiro.test(Cho_initial)
shapiro.test(Cho_final)
shapiro.test(happiness)
```

##Test U de Mann-Whitney

Hipòtesi alternativa (Ha): Els valors de seniority depenen del tipus de treball (qualificat o no qualificat).
Hipòtesi nul·la (Ho): Els valors de seniority no depenen del tipus de treball.
Nivell de significació. Per a tot valor de probabilitat igual o menor que 0.05, s'accepta Ha y se rebutja Ho.

$\alpha = 0.05$
```{r Wilcox análisi del job_type}
wilcox.test(satisfaccioLaboral.seniorityC$seniority,
            satisfaccioLaboral.seniorityPC$seniority, correct=FALSE)
```
Podem afirmar que la hipòtesi alternativa és correcta; hi ha relació entre el job type i el seniority, ja que el resultat és inferior a $\alpha$. 

## Càlculs manuals
  
Recordem que per a una mostra suficientment gran, la mostra produïda pel test es distribueix de forma normal, on:

$$Z = \frac{U - \overline{U}}{\sigma_u}$$
On:
$$U_1 = n_1n_2 + \frac{n_1(n_1 + 1)}{2}-\sum{R_1}$$
$$U_2 = n_1n_2 + \frac{n_2(n_2 + 1)}{2}-\sum{R_2}$$
```{r calculem els valors R1 i R2}
n_1 <- nrow(satisfaccioLaboral.seniorityC)
n_2 <- nrow(satisfaccioLaboral.seniorityPC)
satisfaccioLaboral$seniority.rank <- rank(satisfaccioLaboral$seniority, na.last = TRUE, 
                                          ties.method = "average")
R_1 <- sum(satisfaccioLaboral$seniority.rank[satisfaccioLaboral$job_type == 'PC'])
R_2 <- sum(satisfaccioLaboral$seniority.rank[satisfaccioLaboral$job_type == 'C'])
R_1
R_2
```
Calculem els Valors de $U_1$ i $U_2$:
```{r calculem els valors U1 i U2}
U_1 <- n_1 * n_2 + (n_1 * (n_1 + 1)/2) - R_1
U_2 <- n_1 * n_2 + (n_2 * (n_2 + 1)/2) - R_2
U_1
U_2
```
La fórmula simplificada de $\sigma_u$ és:
$$\sigma_u = \sqrt{\frac{n_1n_2(n_1 + n_2 + 1)}{12}}$$
```{r calculem sigma}
sigma_u <-sqrt((n_1*n_2*(n_1+n_2+1))/12)
sigma_u
```
Calculem $\overline{U}$ com:
$$\overline{U} = \frac{n_1 n_2}{2}$$
```{r calculem mitja de u}
Mitja_U <-(n_1*n_2)/2
Mitja_U
```
I finalment calculem la distribució (com es pot veure, el valor absolut de z és el mateix tant si feim servir $U_1$ com $U_2$):
$$Z = \frac{U - \overline{U}}{\sigma_u}$$
```{r calcul de Z}
z <- (U_1-Mitja_U)/sigma_u
z
z2 <- (U_2-Mitja_U)/sigma_u
z2
```
Si calculem l'àrea associada a aquesta z, podem veure que efectivament es troba a la zona de rebuig de l'hipòtesi nul·la:
```{r àrea de Z}
pnorm(z)
```

##Interpretació

El test U de Mann-Whitney ens permet entendre si dues mostres tenen la mateixa distribució. Si la mostra és prou gran, podem afirmar que, aplicant el test, els resultats s'acosten a una distribució Normal. Això ens permet definir fàcilments les àrees d'acceptació i de rebuig. En el nostre cas, ha estat de rebuig de l'hipòtesi nul·la i acceptació de l'alterna. 

##Reflexió sobre tests paramètrics i no paramètrics
Les distibuicions conegudes (com evidentment és la Normal) tenen un sèrie de característiques i propietats que faciliten el seu tractament. Per exemple, tenim perfectament definit el càlcul de les àrees d'acceptació o rebuig. Una prova és la funció pnorm. No necessita informació de la distribucio per a calcular l'àrea associada. En definitiva: els càlculs són més senzills, més intuitius i més coneguts.
A més, les comparacions entre distriucions són més senzilles si són conegudes. 

## Test sobre el nivell de colesterol
Com ja hem vist, les dues distribucions són molt diferents. De fet, abans ja hem vist que Cho_final s'acosta molt a una distribució normal mentres que cho_initial té molt poca varietat de valors: 
```{r plot cho_ini cho_fin}
par(mfrow=c(1,2))
plot(Cho_initial)
plot(Cho_final)
```
A primer cop d'ull, si restem al colesterol final el colesterol inicial, podem apreciar que la mitja és major que 0. A més, visualment es pot veure que el 0 és fora de l'interval de confiança de la mitja. La primera impresió és que sí sembla que el colesterol final és major que el colesterol inicial.
```{r plot summary cho_dif}
cho_dif <- Cho_final - Cho_initial 
summary(cho_dif)
S_dif <- sd(cho_dif)
S_dif
M_dif <- mean(cho_dif)
M_dif
boxplot.stats(cho_dif)
```
Comprovem si la resta entre el colesterol final i l'inicial s'adequa a la distribució Normal.Com podem veure, és aprop però no arriba a adjustar-se a una distribució Normal.
```{r plot normal cho_dif}
qqplot(cho_dif, rnorm(nrow(satisfaccioLaboral)), main="Cho diferential", ylab = NULL)
shapiro.test(cho_dif)
```
Utilitzarem, doncs, la distribució t de Student per a calcular l'interval de cofiança:
$$\overline{x}\ \pm t_\frac{\alpha}{2}\frac{S}{\sqrt{n}}$$


Per a un interval de confiança de 0.1 i 5 graus de llibertat, obtenim els valors de t de Student:
```{r plot t_student cho_dif}
qt(c(.05, .95), df=5)
```
Calculem l'interval de confiança:
```{r plot interval cho_dif}
M_dif + (qt(0.05, df=5) * (S_dif/sqrt(nrow(satisfaccioLaboral))))
M_dif - (qt(0.05, df=5) * (S_dif/sqrt(nrow(satisfaccioLaboral))))
```
Com es pot veure, l'interval és clarament damunt del 0. Això vol dir que la mostra cho_final és més alta que cho_inicial i que pertanyen a distribucions distintes. 

##Hipòtesi nul·la i alternativa

$H_0$: La distribució de la mostra del colesterol final és superior a la del colesterol inicial

$H_a$: Les diferències són degudes a l'atzar

##Mètode

El ja aplicat. Com es pot veure, els càlculs s'han aplicat sobre la resta de colesterol final - colesterol inicial. Està clar que si el valor és positiu és perque cho_final > cho_inicial. Si és 0, són iguals. Si és negatiu, cho_final < cho_inicial.
El primer que hem fet és veure si aquesta resta segueix una distribució Normal. No és així per poc. Apliquem el test t de Student, que ens permet determinar l'interval de confiança per a una població amb mitja i variança poblacional desconeguda. L'interval NO inclou el 0 i és positiu. Això vol dir que cho_final > cho_inicial.

##Càlculs

Els ja fets.

##Interpretació

S'accepta l'hip`tesi nul·la. El nivell de colesterol s'ha incrementat entre mostres.